<html>    
<head>
<title>Restlet JS Tests - Headers</title> 
    
<link rel="stylesheet" href="../qunit/qunit.css" type="text/css" media="screen">
<script type="text/javascript" src="../jsclass/core.js"></script> 
<script type="text/javascript" src="../jsclass/console.js"></script> 
<script type="text/javascript" src="../qunit/qunit.js"></script> 
<script type="text/javascript" src="../jsonparser/json-minified.js"></script> 
<script type="text/javascript" src="../restlet/restlet-browser.js"></script> 

<script type="text/javascript"> 
module("Header Restlet JS client tests");

asyncTest("Custom headers", function() {
	var clientResource = new ClientResource("/contact/1");

	var additionalHeaders = clientResource.getRequestAttributes()[HeaderConstants.ATTRIBUTE_HEADERS];
	if (additionalHeaders==null) {
		additionalHeaders = new Series();
		clientResource.getRequestAttributes()[HeaderConstants.ATTRIBUTE_HEADERS] = additionalHeaders;
	}
	additionalHeaders.set("MyHeader", "MyValue");

	Engine.getInstance().setDebugHandler({
		beforeSendingRequest: function(url, method, headers, data) {
			ok(headers["MyHeader"], "MyValue");
		}
	});

	clientResource.get(function(representation) {
		var content = representation.getText();
		ok(content, "{\"id\":\"1\",\"lastName\":\"lastName1\",\"firstName\":\"firstName1\",\"email\":null}");
		var date = representation.getModificationDate();
		start();
	}, MediaType.APPLICATION_JSON);
});

asyncTest("Tag header", function() {
	var clientResource = new ClientResource("/contact/1");

	var contact = {
			id: "1",
			lastName: "lastName",
			firstName: "firstName"
	};
	var jsonRepresentation = new JsonRepresentation(contact);
	jsonRepresentation.setTag(new Tag("TAG"));

	Engine.getInstance().setDebugHandler({
		beforeSendingRequest: function(url, method, headers, data) {
			ok(headers["ETag"], "W/\"TAG\"");
		}
	});

	clientResource.put(jsonRepresentation, function(representation) {
		var jsonRepresentation = new JsonRepresentation(representation);
		var obj = jsonRepresentation.getObject();
		ok(obj.id, "1");
		ok(obj.lastName, "lastName");
		ok(obj.firstName, "firstName");
		start();
	}, MediaType.APPLICATION_JSON);
});

asyncTest("Range header", function() {
	var clientResource = new ClientResource("/contact/1");

	var contact = {
			id: "1",
			lastName: "lastName",
			firstName: "firstName"
	};
	var jsonRepresentation = new JsonRepresentation(contact);
	jsonRepresentation.setRange(new Range(10, 30));
	clientResource.getRequest().setRanges([ new Range(10, 30), new Range(11, 31)]);

	Engine.getInstance().setDebugHandler({
		beforeSendingRequest: function(url, method, headers, data) {
			ok(headers["Content-Range"], "bytes 10-39/*");
			ok(headers["Range"], "bytes=10-39, 11-41");
		}
	});

	clientResource.put(jsonRepresentation, function(representation) {
		var jsonRepresentation = new JsonRepresentation(representation);
		var obj = jsonRepresentation.getObject();
		ok(obj.id, "1");
		ok(obj.lastName, "lastName");
		ok(obj.firstName, "firstName");
		start();
	}, MediaType.APPLICATION_JSON);
});

asyncTest("Conditions header", function() {
	var clientResource = new ClientResource("/contact/1");

	var contact = {
			id: "1",
			lastName: "lastName",
			firstName: "firstName"
	};
	var jsonRepresentation = new JsonRepresentation(contact);
	var conditions = clientResource.getRequest().getConditions();
	var now = new Date();
	conditions.getMatch().push("match");
	conditions.setModifiedSince(now);
	conditions.getNoneMatch().push("nonematch");
	conditions.setRangeTag(new Tag("range"));
	conditions.setUnmodifiedSince(now);

	Engine.getInstance().setDebugHandler({
		beforeSendingRequest: function(url, method, headers, data) {
			ok(headers["If-Match"], "match");
			ok(headers["If-Modified-Since"], DateUtils.format(now));
			ok(headers["If-None-Match"], "nonematch");
			ok(headers["If-Range"], "W/\"range\"");
			ok(headers["If-Unmodified-Since"], DateUtils.format(now));
		}
	});

	clientResource.put(jsonRepresentation, function(representation) {
		var jsonRepresentation = new JsonRepresentation(representation);
		var obj = jsonRepresentation.getObject();
		/*ok(obj.id, "1");
		ok(obj.lastName, "lastName");
		ok(obj.firstName, "firstName");*/
		start();
	}, MediaType.APPLICATION_JSON);
});

asyncTest("Cookie header", function() {
	var clientResource = new ClientResource("/contact/1");

	var contact = {
			id: "1",
			lastName: "lastName",
			firstName: "firstName"
	};
	var jsonRepresentation = new JsonRepresentation(contact);
	clientResource.getRequest().getCookies().add(new Cookie("Name", "Value"));
	
	Engine.getInstance().setDebugHandler({
		beforeSendingRequest: function(url, method, headers, data) {
			ok(headers["Cookie"], "Name=Value");
		}
	});

	clientResource.put(jsonRepresentation, function(representation) {
		var jsonRepresentation = new JsonRepresentation(representation);
		var obj = jsonRepresentation.getObject();
		ok(obj.id, "1");
		ok(obj.lastName, "lastName");
		ok(obj.firstName, "firstName");
		start();
	}, MediaType.APPLICATION_JSON);
});

asyncTest("HTTP basic header", function() {
	var clientResource = new ClientResource("/contact/1");
	clientResource.setChallengeResponse(
            new ChallengeResponse(
                  ChallengeScheme.HTTP_BASIC,
                  "username", "password"));

	var contact = {
			id: "1",
			lastName: "lastName",
			firstName: "firstName"
	};
	var jsonRepresentation = new JsonRepresentation(contact);
	
	Engine.getInstance().setDebugHandler({
		beforeSendingRequest: function(url, method, headers, data) {
			console.log("cookie = "+headers[HeaderConstants.HEADER_COOKIE]);
		}
	});

	clientResource.put(jsonRepresentation, function(representation) {
		console.log("representation.getText() = "+representation.getText());
		var jsonRepresentation = new JsonRepresentation(representation);
		var obj = jsonRepresentation.getObject();
		ok(obj.id, "1");
		ok(obj.lastName, "lastName");
		ok(obj.firstName, "firstName");
		start();
	}, MediaType.APPLICATION_JSON);
});

</script> 
</head>
 
<body>
<!-- QUnit will fill in the contents of these elements for you (except for qunit-header) --> 
    <h1 id="qunit-header">Basic QUnit Demo</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup</div>
</body></html>